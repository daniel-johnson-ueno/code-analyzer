<template>
    <div class="c-container slds-scrollable_x">
        <template for:each={loansresponse} for:item="loan">
            <div key={loan.accountNumber} class="custom-box" onclick={handleLoanClick}
                data-account-number={loan.accountNumber}>

                <div class="title-section">
                    <h2 class="account-title"><img style="margin-top: -2px;" src="https://i.imgur.com/E75mVHz.png" alt="Caja de ahorro" width="16" height="16" /> <strong>  {loan.accountNumber}</strong></h2>

                    <template lwc:if={loan.isActive}>
                        <div class="pill success-pill">{loan.status}</div>
                    </template>
                    <template lwc:elseif={loan.isNeutral}>
                        <div class="pill neutral-pill">{loan.status}</div>
                    </template>
                    <template lwc:elseif={loan.isError}>
                        <div class="pill error-pill">{loan.status}</div>
                    </template>
                </div>

                <hr class="faded-line">

                <div class="container-details">
                    <div class="slds-grid  slds-var-p-vertical_x-small">
                        <div class="slds-col slds-size_1-of-1">
                            <strong>Tipo: </strong>{loan.type}
                        </div>
                    </div>
                    <div class="slds-grid  slds-var-p-vertical_x-small">
                        <div class="slds-col slds-size_1-of-1">
                            <strong>Moneda: </strong>{loan.moreDetails.currencyDes}
                        </div>
                    </div>
                    <div class="slds-grid  slds-var-p-vertical_x-small">
                        <div class="slds-col slds-size_1-of-1">
                            <strong>Inicio: </strong>{loan.startDate}
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <template if:true={selectedLoanDetailNumber}>
        <div class="slds-grid slds-wrap some-margin-both-sides">

            <div class="slds-col slds-size_1-of-1">
                <div class="slds-col slds-size_1-of-1">
                    <div>
                        <div class="pill blue-tab-pill">
                            <div class="pill-tab-text">Detalle</div>
                        </div>
                        <template lwc:if={isNotEmployee}>
                            <div class="pill white-pill left-pill" onclick={handleMovementsLoans}>
                                <div class="pill-tab-text">Movimientos</div>
                            </div>
                        </template>
                    </div>
                </div>
                <br/>

                <div class="slds-grid  slds-var-p-vertical_x-small">
                    <div class="slds-col slds-size_1-of-2">
                        <strong>Moneda: </strong>{selectedLoan.currencyDes}
                    </div>
                </div>
                <div class="slds-grid  slds-var-p-vertical_x-small">
                    <div class="slds-col slds-size_1-of-2">
                        <strong>Tipo de préstamo: </strong>{selectedLoan.modality}
                    </div>
                    <template lwc:if={isNotEmployee}>
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Seguro de Cancelación de Deuda: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedLoan.debtCancellationInsurance}></lightning-formatted-number>
                        </div>
                    </template>
                </div>
                <template lwc:if={isNotEmployee}>
                    <div class="slds-grid  slds-var-p-vertical_x-small">
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Monto Desembolsado: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedLoan.outlayAmount}></lightning-formatted-number>
                        </div>
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Seguro de Desempleo: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedLoan.unemploymentInsurance}></lightning-formatted-number>
                        </div>
                    </div>
                    <div class="slds-grid  slds-var-p-vertical_x-small">
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Deuda total: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedLoan.totalAmount}></lightning-formatted-number>
                        </div>
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Cargos por Cancelación Anticipada: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedLoan.earlyCancellationCharges}></lightning-formatted-number>
                        </div>
                    </div>
                </template>
                <div class="slds-grid  slds-var-p-vertical_x-small">
                    <div class="slds-col slds-size_1-of-2">
                        <strong>Cantidad de Cuotas: </strong>{selectedLoan.totalFees}
                    </div>
                    <template lwc:if={isNotEmployee}>
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Deuda Pendiente: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedLoan.pendingDebt}></lightning-formatted-number>
                        </div>
                    </template>
                </div>
                <div class="slds-grid  slds-var-p-vertical_x-small">
                    <div class="slds-col slds-size_1-of-2">
                        <strong>Cuotas Pagadas: </strong>{selectedLoan.feesPaid}
                    </div>
                    <div class="slds-col slds-size_1-of-2">
                        <strong>Cuotas Pendientes: </strong>{selectedLoan.pendingFees}
                    </div>
                </div>
                <template lwc:if={isNotEmployee}>
                    <div class="slds-grid  slds-var-p-vertical_x-small">
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Tasa: </strong>{selectedLoan.tas}
                        </div>
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Cancelación Anticipada: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedLoan.payoffAmount}></lightning-formatted-number>
                        </div>
                    </div>
                    <div class="slds-grid  slds-var-p-vertical_x-small">
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Saldo Capital: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedLoan.capitalBalance}></lightning-formatted-number>
                        </div>
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Último Monto Total Pagado: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedLoan.lastTotalAmountPaid}></lightning-formatted-number>
                        </div>
                    </div>
                </template>
                <div class="slds-grid  slds-var-p-vertical_x-small">
                    <div class="slds-col slds-size_1-of-2">
                        <strong>Última Fecha de Pago: </strong>{selectedLoan.lastPaymentDate}
                    </div>
                    <div class="slds-col slds-size_1-of-2">
                        <strong>Saldo en Mora: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedLoan.expiredAmount}></lightning-formatted-number>
                    </div>
                </div>
                <template lwc:if={isNotEmployee}>
                    <div class="slds-grid  slds-var-p-vertical_x-small">
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Número de Solicitud: </strong>{selectedLoan.requestNumber}
                        </div>
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Días de Atraso: </strong>{selectedLoan.daysPastDue}
                        </div>
                    </div>
                    <div class="slds-grid  slds-var-p-vertical_x-small">
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Gastos administrativos: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedLoan.administrativeCommission}></lightning-formatted-number>
                        </div>
                        <div class="slds-col slds-size_1-of-1">
                            <strong>Seguro de Sepelio: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedLoan.burialInsurance}></lightning-formatted-number>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </template>

    <template if:true={isLoading}>
        <lightning-spinner alternative-text="Loading" size="small"></lightning-spinner>
    </template>

    <template if:true={recentLoanMovements}>
        <div class="some-margin-both-sides">

            <div class="slds-col slds-size_1-of-1">
                <div>
                    <div class="pill white-pill" onclick={handleReturnLoans}>
                        <div class="pill-tab-text">Detalle</div>
                    </div>
                    <div class="pill blue-tab-pill left-pill">
                        <div class="pill-tab-text">Movimientos</div>
                    </div>
                </div>
            </div>
            <br>

            <div class="common-card-style">
                <div class="slds-grid slds-wrap">
                    <div class="slds-col slds-size_1-of-1 slds-grow-none slds-var-p-horizontal_xxx-small slds-var-p-vertical_xxx-small">
                        <lightning-datatable key-field="installmentId"
                                             data={recentLoanMovements}
                                             columns={movementsColumns}
                                             hide-checkbox-column="true"
                                             onrowaction={handleShowLoanMovementDetails}>
                        </lightning-datatable>
                    </div>
                </div>
            </div>

            <div class="slds-float_left">
                <lightning-button variant="base" label="Previo" title="Previo" onclick={handlePrevioLoans}
                    class="slds-m-left_x-small slds-p-around_medium"></lightning-button>
            </div>
            <div class="slds-float_right">
                <lightning-button variant="base" label="Siguiente" title="Siguiente" onclick={handleSiguienteLoans}
                    class="slds-m-right_x-small slds-p-around_medium"></lightning-button>
            </div>
            <br>
            <br>
        </div>
    </template>

    <template if:true={showLoanMovementDetails}>
        <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <div class="slds-modal__content slds-p-around_medium common-modal-full-rounded" id="modal-content-id-4">

                    <!--Header-->
                    <div>
                        <div class="slds-grid">
                            <div class="slds-col slds-size_9-of-12">
                                <div class="common-modal-title">Detalles de la cuota</div>
                            </div>
                            <div class="slds-col slds-size_3-of-12">
                                <div class="common-modal-close-button" onclick={toggleLoanMovementDetailsPanel}>
                                    <lightning-icon icon-name="utility:close" alternative-text="Star" size="xx-small" title="large size"></lightning-icon>
                                </div>
                            </div>
                        </div>
                        <div class="slds-grid">
                            <div class="slds-col slds-size_1-of-1">
                                <div class="common-modal-sub-title">{selectedLoanMovement.installmentNumber} - {selectedLoanMovement.expirationDate}</div>
                            </div>
                        </div>
                        <hr class="faded-line">
                    </div>

                    <!--Body-->
                    <br/>
                    <div class="movement-details-row">
                        <div class="slds-grid">
                            <div class="slds-col slds-size_1-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-label">
                                Estado
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-label">
                                Días de Mora
                            </div>
                        </div>
                        <div class="slds-grid">
                            <div class="slds-col slds-size_1-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-value">
                                {selectedLoanMovement.status}
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-value">
                                {selectedLoanMovement.daysPastDueDesc}
                            </div>
                        </div>
                    </div>

                    <div class="movement-details-row">
                        <div class="slds-grid">
                            <div class="slds-col slds-size_1-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-label">
                                Cantidad
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-label">
                                Saldo interes
                            </div>
                        </div>
                        <div class="slds-grid">
                            <div class="slds-col slds-size_1-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-value">
                                {selectedLoanMovement.amount}
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-value">
                            </div>
                        </div>
                    </div>

                    <div class="movement-details-row">
                        <div class="slds-grid">
                            <div class="slds-col slds-size_1-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-label">
                                Ultimo pago Días
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-label">
                            </div>
                        </div>
                        <div class="slds-grid">
                            <div class="slds-col slds-size_1-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-value">
                                {selectedLoanMovement.paymentDate}
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-value">
                            </div>
                        </div>
                    </div>
                    <br/>
                    <template if:true={isCaseRecord}>
                        <hr class="faded-line">
                        <br/>
    
                        <div class="slds-grid slds-gutters">
                            <div class="slds-col slds-size_2-of-3">
                            </div>
                            <div class="slds-col slds-size_1-of-3">
                                <lightning-button variant="brand" label="Asociar al Caso" title="asociarCaso" onclick={onButtonAsocChange} class="slds-p-around_medium" icon-name="utility:case"></lightning-button>
                            </div>
                          </div>
    
                    </template>
                </div>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
</template>