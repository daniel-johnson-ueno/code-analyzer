<template>
    <div class="c-container slds-scrollable_x">
        <template for:each={cardsResponse} for:item="cardToProcess">
            <div key={cardToProcess.cardNumber} class="custom-box"
                data-card-number={cardToProcess.cardNumber} onclick={handleCardClick}>

                <div class="title-section">
                    <h2 class="account-title"><img style="margin-top: -2px;" src="https://i.imgur.com/ZdMiVuW.png" alt="Tarjeta" width="16" height="16" /> 
                        <template if:true={cardToProcess.isCredit}> Crédito</template>
                        <template if:false={cardToProcess.isCredit}> Débito</template>
                        <strong> {cardToProcess.cardNumberShort}</strong></h2>

                    <template lwc:if={cardToProcess.isActive}>
                        <div class="pill success-pill">{cardToProcess.status}</div>
                    </template>
                    <template lwc:elseif={cardToProcess.isNeutral}>
                        <div class="pill neutral-pill">{cardToProcess.status}</div>
                    </template>
                    <template lwc:elseif={cardToProcess.isError}>
                        <div class="pill error-pill">{cardToProcess.status}</div>
                    </template>
                </div>

                <hr class="faded-line">

                <div class="container-details">
                    <div class="slds-grid  slds-var-p-vertical_x-small">
                        <div class="slds-col slds-size_1-of-1">
                            <strong>{cardToProcess.name}</strong>
                        </div>
                    </div>
                    <div class="slds-grid  slds-var-p-vertical_x-small">
                        <div class="slds-col slds-size_1-of-1">
                            {cardToProcess.cardType}
                        </div>
                    </div>
                </div>
            </div>
        </template>

    </div>

    <template if:true={selectedCardDetailNumber}>
        <div class="slds-grid slds-wrap some-margin-both-sides">

            <div class="slds-col slds-size_1-of-1">
                <div class="slds-col slds-size_1-of-1">
                    <div>
                        <div class="pill blue-tab-pill">
                            <div class="pill-tab-text">Detalle</div>
                        </div>
                        <template lwc:if={isNotEmployee}>
                            <div class="pill white-pill left-pill" onclick={handleMovementsCards}>
                                <div class="pill-tab-text">Movimientos</div>
                            </div>
                        </template>
                    </div>
                </div>
                <br/>

                <!-- DEBITO -->
                <template if:false={selectedCardIsCredit}>
                    <div class="slds-grid  slds-var-p-vertical_x-small">
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Numero de cuenta: </strong>{selectedCard.accountNumber}
                        </div>
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Fecha de Vencimiento: </strong>{selectedCard.dueDate}
                        </div>
                    </div>
                    <div class="slds-grid  slds-var-p-vertical_x-small">
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Código de Oficina de Origen: </strong>{selectedCard.originOfficeCode}
                        </div>
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Fecha de Cancelación: </strong>{selectedCard.cancellationDate}
                        </div>
                    </div>
                    <div class="slds-grid  slds-var-p-vertical_x-small">
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Fecha del Último Movimiento en Cajero Automático: </strong>{selectedCard.lastATMMovementDate}
                        </div>
                        <div class="slds-col slds-size_1-of-2">
                            <strong>Fecha de Activación: </strong>{selectedCard.activationDate}
                        </div>
                    </div>
                </template>

                <!-- CREDITO -->
                <template if:true={selectedCardIsCredit}>
                    <div class="slds-grid  slds-var-p-vertical_medium slds-var-p-horizontal_small">
                        <div class="slds-col slds-size_1-of-1 slds-var-p-horizontal_x-small">
                            <strong>Moneda: </strong>{selectedCard.currencyDes}
                        </div>
                    </div>
                    <template lwc:if={isNotEmployee} >
                        <div class="slds-grid card-header-section-first">
                            <div class="slds-col slds-size_1-of-1 slds-grow-none slds-var-p-horizontal_x-small">
                                <span class="card-title">Saldos</span>
                            </div>
                        </div>
                        <div class="slds-grid  slds-var-p-vertical_x-small slds-var-p-horizontal_small">
                            <div class="slds-col slds-size_1-of-2 slds-var-p-horizontal_x-small">
                                <strong>Linea de Crédito: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedCard.creditLine}></lightning-formatted-number>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-var-p-horizontal_small">
                                <strong>Línea de Crédito Disponible: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedCard.availableCreditLine}></lightning-formatted-number>
                            </div>
                        </div>
                        <div class="slds-grid  slds-var-p-vertical_x-small slds-var-p-horizontal_small">
                            <div class="slds-col slds-size_1-of-2 slds-var-p-horizontal_x-small">
                                <strong>Linea de Crédito Usada: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedCard.creditLineUsed}></lightning-formatted-number>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-var-p-horizontal_small">
                                <strong>Reembolso: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedCard.cashBack}></lightning-formatted-number>
                            </div>
                        </div>
                    </template>

                    <div class="slds-grid card-header-section">
                        <div class="slds-col slds-size_1-of-1 slds-grow-none slds-var-p-horizontal_x-small">
                            <span class="card-title">Datos del plástico</span>
                        </div>
                    </div>
                    <div class="slds-grid  slds-var-p-vertical_x-small slds-var-p-horizontal_small">
                        <div class="slds-col slds-size_1-of-2 slds-var-p-horizontal_x-small">
                            <strong>Titular: </strong>{selectedCard.holder}
                        </div>
                        <div class="slds-col slds-size_1-of-2 slds-var-p-horizontal_small">
                            <strong>Numero de Cuenta: </strong>{selectedCard.accountNumber}
                        </div>
                    </div>
                    <div class="slds-grid  slds-var-p-vertical_x-small slds-var-p-horizontal_small">
                        <template lwc:if={isNotEmployee} >
                            <div class="slds-col slds-size_1-of-2 slds-var-p-horizontal_x-small">
                                <strong>Fecha de Vencimiento: </strong>{selectedCard.dueDate}
                            </div>
                        </template>
                        <div class="slds-col slds-size_1-of-2 slds-var-p-horizontal_x-small">
                            <strong>Color de la Tarjeta: </strong>{selectedCard.cardColor}
                        </div>
                    </div>
                    <div class="slds-grid  slds-var-p-vertical_x-small slds-var-p-horizontal_small">
                        <div class="slds-col slds-size_1-of-1 slds-var-p-horizontal_x-small">
                            <strong>Afinidad: </strong>{selectedCard.affinity}
                        </div>
                    </div>

                    <template lwc:if={isNotEmployee} >
                        <div class="slds-grid card-header-section">
                            <div class="slds-col slds-size_1-of-1 slds-grow-none slds-var-p-horizontal_x-small">
                                <span class="card-title">Datos de extracto</span>
                            </div>
                        </div>
                        <div class="slds-grid  slds-var-p-vertical_x-small slds-var-p-horizontal_small">
                            <div class="slds-col slds-size_1-of-2 slds-var-p-horizontal_x-small">
                                <strong>Vencimiento del extracto: </strong>{selectedCard.extractExpirationDate}
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-var-p-horizontal_small">
                                <strong>Tasa de Interés: </strong>{selectedCard.interestRate}
                            </div>
                        </div>
                        <div class="slds-grid  slds-var-p-vertical_x-small slds-var-p-horizontal_small">
                            <div class="slds-col slds-size_1-of-1 slds-var-p-horizontal_x-small">
                                <strong>Tiene Débito Automático: </strong>{selectedCard.hasAutomaticDebit}
                            </div>
                        </div>
                    </template>

                    <template lwc:if={isNotEmployee}>
                        <div class="slds-grid card-header-section">
                            <div class="slds-col slds-size_1-of-1 slds-grow-none slds-var-p-horizontal_x-small">
                                <span class="card-title">Pagos</span>
                            </div>
                        </div>
                        <div class="slds-grid  slds-var-p-vertical_x-small slds-var-p-horizontal_small">
                            <div class="slds-col slds-size_1-of-2 slds-var-p-horizontal_x-small">
                                <strong>Pagos realizados en el mes: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedCard.monthPaymentAmount}></lightning-formatted-number>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-var-p-horizontal_small">
                                <strong>Último Pago: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedCard.lastPayment}></lightning-formatted-number>
                            </div>
                        </div>
                        <div class="slds-grid  slds-var-p-vertical_x-small slds-var-p-horizontal_small">
                            <div class="slds-col slds-size_1-of-2 slds-var-p-horizontal_x-small">
                                <strong>Monto de Pago Mensual: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedCard.monthPaymentAmount}></lightning-formatted-number>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-var-p-horizontal_small">
                                <strong>Pago Minimo: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedCard.minimumPay}></lightning-formatted-number>
                            </div>
                        </div>
                    </template>

                    <template lwc:if={isNotEmployee}>
                        <div class="slds-grid card-header-section">
                            <div class="slds-col slds-size_1-of-1 slds-grow-none slds-var-p-horizontal_x-small">
                                <span class="card-title">Facturación</span>
                            </div>
                        </div>
                        <div class="slds-grid  slds-var-p-vertical_x-small slds-var-p-horizontal_small">
                            <div class="slds-col slds-size_1-of-2 slds-var-p-horizontal_x-small">
                                <strong>Tipo de Pago Débito Automático: </strong>{selectedCard.paymentTypeAutomaticDebit}
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-var-p-horizontal_small">
                                <strong>Deuda Total: </strong><lightning-formatted-number format-style="decimal" minimum-fraction-digits="2" value={selectedCard.totalDebt}></lightning-formatted-number>
                            </div>
                        </div>
                    </template>
                </template>
            </div>
        </div>
    </template>

    <template if:true={isLoading}>
        <lightning-spinner alternative-text="Loading" size="small"></lightning-spinner>
    </template>

<!--    <template if:false={movementsFound}>-->
<!--        <strong>No se encontraron movimientos relacionados</strong>-->
<!--    </template>-->

    <template if:true={recentCardMovements}>
        <div class="some-margin-both-sides">

            <div class="slds-col slds-size_1-of-1">
                <div>
                    <div class="pill white-pill" onclick={handleReturnCards}>
                        <div class="pill-tab-text">Detalle</div>
                    </div>
                    <div class="pill blue-tab-pill left-pill">
                        <div class="pill-tab-text">Movimientos</div>
                    </div>
                </div>
            </div>
            <br>

            <template lwc:if={recentCardMovements}>
                <div class="slds-grid">

                    <lightning-layout multiple-rows>
                        <lightning-layout-item padding="around-small" size="12" small-device-size="6" medium-device-size="4" large-device-size="3">
                            <lightning-input max={toDate} min={minDate} type="date" name="fromDate" label="Fecha inicio" value={fromDate} onchange={onDateChange} date-style="medium" title="Solo puedes seleccionar fechas dentro de un rango de 30 días antes y hasta hoy."></lightning-input>
                        </lightning-layout-item>
                        <lightning-layout-item padding="around-small" size="12" small-device-size="6" medium-device-size="4" large-device-size="3">
                            <lightning-input min={fromDate} type="date" name="toDate" label="Fecha fin" value={toDate} onchange={onDateChange} date-style="medium" title="Solo puedes seleccionar fechas dentro de un rango de 30 días antes y hasta hoy."></lightning-input>
                        </lightning-layout-item>
                    </lightning-layout>
                </div>
                <br>

                <template lwc:if={movementsFound}>
                    <div class="common-card-style">
                        <div class="slds-grid slds-wrap">
                            <div class="slds-col slds-size_1-of-1 slds-grow-none slds-var-p-horizontal_xxx-small slds-var-p-vertical_xxx-small">

                                <lightning-datatable key-field="movementId"
                                                     data={recentCardMovements}
                                                     columns={genericMovementColumns}
                                                     hide-checkbox-column="true"
                                                     onrowaction={handleShowCardMovementDetails}>
                                </lightning-datatable>
                            </div>
                        </div>
                    </div>
                </template>

                <template lwc:else>
                    <div class ="slds-var-p-horizontal_x-small">
                        <strong>No se encontraron (más) movimientos para el rango de fechas seleccionado</strong>
                    </div>
                </template>

                <template lwc:if={showBack}>
                    <div class="slds-float_left">
                        <lightning-button variant="base" label="Previo" title="Previo" onclick={handlePrevioCards}
                                          class="slds-m-left_x-small slds-p-around_medium">
                        </lightning-button>
                    </div>

                </template>

                <template lwc:if={showNext}>
                    <div class="slds-float_right">
                        <lightning-button variant="base" label="Siguiente" title="Siguiente"
                                          onclick={handleSiguienteCards}
                                          class="slds-m-right_x-small slds-p-around_medium">
                        </lightning-button>
                    </div>
                </template>

            </template>

<!--            <div class="common-card-style">-->
<!--                <div class="slds-grid slds-wrap">-->
<!--                    <div class="slds-col slds-size_1-of-1 slds-grow-none slds-var-p-horizontal_xxx-small slds-var-p-vertical_xxx-small">-->
<!--                        <lightning-datatable key-field="movementId"-->
<!--                                             data={recentCardMovements}-->
<!--                                             columns={genericMovementColumns}-->
<!--                                             hide-checkbox-column="true"-->
<!--                                             onrowaction={handleShowCardMovementDetails}>-->
<!--                        </lightning-datatable>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="slds-float_left">-->
<!--                <lightning-button variant="base" label="Previo" title="Previo" onclick={handlePrevioCards}-->
<!--                    class="slds-m-left_x-small slds-p-around_medium"></lightning-button>-->
<!--            </div>-->
<!--            <div class="slds-float_right">-->
<!--                <lightning-button variant="base" label="Siguiente" title="Siguiente"-->
<!--                    onclick={handleSiguienteCards}-->
<!--                    class="slds-m-right_x-small slds-p-around_medium"></lightning-button>-->
<!--            </div>-->
<!--            <br>-->
<!--            <br>-->
        </div>
    </template>

    <template if:true={showCardMovementDetails}>
        <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <div class="slds-modal__content slds-p-around_medium common-modal-full-rounded" id="modal-content-id-5">

                    <!--Header-->
                    <div>
                        <div class="slds-grid">
                            <div class="slds-col slds-size_9-of-12">
                                <div class="common-modal-title">Detalles de la cuota</div>
                            </div>
                            <div class="slds-col slds-size_3-of-12">
                                <div class="common-modal-close-button" onclick={toggleCardMovementDetailsPanel}>
                                    <lightning-icon icon-name="utility:close" alternative-text="Star" size="xx-small" title="large size"></lightning-icon>
                                </div>
                            </div>
                        </div>
                        <div class="slds-grid">
                            <div class="slds-col slds-size_1-of-1">
                                <div class="common-modal-sub-title">{selectedCardMovement.movementType} - {selectedCardMovement.movementDate}</div>
                            </div>
                        </div>
                        <hr class="faded-line">
                    </div>

                    <!--Body-->
                    <br/>
                    <div class="movement-details-row">
                        <div class="slds-grid">
                            <div class="slds-col slds-size_2-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-label">
                                Número de comprobante
                            </div>
                        </div>
                        <div class="slds-grid">
                            <template lwc:if={selectedCardMovement.description}>
                                <div class="slds-col slds-size_2-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-value">
                                    {selectedCardMovement.receiptNumber}
                                </div>
                            </template>
                            <template lwc:else>
                                <div class="slds-col slds-size_2-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-value">
                                </div>
                            </template>
                        </div>
                    </div>
                    <br/>
                    <div class="movement-details-row">
                        <div class="slds-grid">
                            <div class="slds-col slds-size_1-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-label">
                                Descripcion
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-label">
                                Monto
                            </div>
                        </div>
                        <div class="slds-grid">

                            <template lwc:if={selectedCardMovement.description}>
                                <div class="slds-col slds-size_1-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-value">
                                    {selectedCardMovement.description}
                                </div>
                            </template>

                            <template lwc:else>
                                <div class="slds-col slds-size_1-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-value">
                                </div>
                            </template>

                            <div class="slds-col slds-size_1-of-2 slds-grow-none slds-var-p-horizontal_small movement-details-value">
                                {selectedCardMovement.amount}
                            </div>
                        </div>
                    </div>
                    <br/>
                    <template if:true={isCaseRecord}>
                        <hr class="faded-line">
                        <br/>
                        <div class="slds-grid slds-gutters">
                            <div class="slds-col slds-size_2-of-3">
                            </div>
                            <div class="slds-col slds-size_1-of-3">
                                <lightning-button variant="brand" label="Asociar al Caso" title="asociarCaso" onclick={onButtonAsocChange} class="slds-p-around_medium" icon-name="utility:case"></lightning-button>
                            </div>
                          </div>
                    </template>
                </div>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
</template>