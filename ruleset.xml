<?xml version="1.0" encoding="UTF-8"?>
<ruleset name="Itti Custom Ruleset"
         xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 http://pmd.sourceforge.net/ruleset_2_0_0.xsd">

    <description>
        Reglas customizadas para CRM.
    </description>

    <!-- ================================================================= -->
    <!-- REGLAS PARA APEX                                                  -->
    <!-- ================================================================= -->

<!-- REGLAS CUSTOM -->
    <rule name="EnforceGenerateErrorLogEvent"
          language="apex"
          message="Todo bloque Catch debe llamar a GenerateLogEvent.generateErrorLogEvent(...)"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>
            Asegura que no se silencien errores. Se requiere el uso del logger estandar.
        </description>
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                    //CatchBlockStatement[
                        count(
                           .//MethodCallExpression[
                               lower-case(@MethodName) = 'generateerrorlogevent'
                           ]
                        ) = 0
                    ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>

    <!-- Por el momento queda solo en warning, pero lo vamos a ajustar a error en el futuro -->
    <rule name="EnforceDAOPattern"
          language="apex"
          message="No se permiten SOQLs (ni Database.query) en esta clase. Mover la consulta a una clase DAO."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>
            Permite SOQL solo en:
            1. Clases con 'DAO' en el nombre.
            2. Clases que tengan un metodo 'execute' (Batch, Queueable, Schedulable).
            3. Clases que tengan un metodo 'start' (Batch).
        </description>
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                    //UserClass
                    [
                        not(contains(lower-case(@Image), 'dao'))
                    ]
                    [
                        count(.//Method[lower-case(@Image)='execute']) = 0
                    ]
                    [
                        count(.//Method[lower-case(@Image)='start']) = 0
                    ]
                    [
                        .//SoqlExpression
                        or
                        .//MethodCallExpression[
                            lower-case(@MethodName) = 'query' and
                            .//ReferenceExpression[lower-case(@Image) = 'database']
                        ]
                    ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>

    <!-- Por el momento queda solo en warning, pero lo vamos a ajustar a error en el futuro -->
    <rule name="EnforceSOQLHelperInDAO"
          language="apex"
          message="Los metodos DAO con queries deben utilizar SOQLHelper para garantizar FLS y sanitizacion."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>
            Para asegurar que se respeten los permisos de campos (FLS) y se evite la inyeccion SOQL,
            cualquier consulta en un DAO debe construirse utilizando las utilidades de la clase SOQLHelper.
        </description>
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                    //UserClass[contains(lower-case(@Image), 'dao')]
                      //Method
                      [
                        (
                          .//SoqlExpression
                          or
                          .//MethodCallExpression[
                              lower-case(@MethodName) = 'query'
                              and
                              .//ReferenceExpression[lower-case(@Image) = 'database']
                          ]
                        )
                      ]
                      [
                        count(.//ReferenceExpression[lower-case(@Image) = 'soqlhelper']) = 0
                      ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>


<!-- SECURITY: https://pmd.github.io/pmd/pmd_rules_apex_security.html -->
<!-- Por el momento queda solo en warning, pero lo vamos a ajustar a error en el futuro -->
    <rule ref="category/apex/security.xml/ApexOpenRedirect" />
    <rule ref="category/apex/security.xml/ApexSharingViolations" />
    <rule ref="category/apex/security.xml/ApexSOQLInjection" />
    <rule ref="category/apex/security.xml/ApexSuggestUsingNamedCred" />
    <rule ref="category/apex/security.xml/ApexXSSFromEscapeFalse" />
    <rule ref="category/apex/security.xml/ApexXSSFromURLParam" />


<!-- DESIGN: https://pmd.github.io/pmd/pmd_rules_apex_design.html -->
<!-- Por el momento queda solo en warning, pero lo vamos a ajustar a error en el futuro -->
    <rule ref="category/apex/design.xml/ExcessiveParameterList">
        <properties>
            <property name="minimum" value="4" />
        </properties>
    </rule>
    <rule ref="category/apex/design.xml/AvoidDeeplyNestedIfStmts">
        <properties>
            <property name="problemDepth" value="3" />
        </properties>
    </rule>
    <rule ref="category/apex/design.xml/CognitiveComplexity">
        <properties>
            <property name="classReportLevel" value="150" />
            <property name="methodReportLevel" value="15" />
        </properties>
    </rule>


<!-- BEST PRACTICES: https://pmd.github.io/pmd/pmd_rules_apex_bestpractices.html -->
    <rule ref="category/apex/bestpractices.xml/ApexAssertionsShouldIncludeMessage">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/bestpractices.xml/ApexUnitTestClassShouldHaveAsserts">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/bestpractices.xml/ApexUnitTestMethodShouldHaveIsTestAnnotation">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/bestpractices.xml/ApexUnitTestShouldNotUseSeeAllDataTrue">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/bestpractices.xml/AvoidLogicInTrigger">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/bestpractices.xml/UnusedLocalVariable">
        <priority>1</priority>
    </rule>


<!-- CODE STYLE: https://pmd.github.io/pmd/pmd_rules_apex_codestyle.html -->
    <rule ref="category/apex/codestyle.xml/ClassNamingConventions">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/codestyle.xml/MethodNamingConventions">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/codestyle.xml/FieldNamingConventions">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/codestyle.xml/LocalVariableNamingConventions">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/codestyle.xml/PropertyNamingConventions">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/codestyle.xml/ForLoopsMustUseBraces">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/codestyle.xml/FormalParameterNamingConventions">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/codestyle.xml/OneDeclarationPerLine">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/codestyle.xml/WhileLoopsMustUseBraces">
        <priority>1</priority>
    </rule>


<!-- ERROR PRONE: https://pmd.github.io/pmd/pmd_rules_apex_errorprone.html -->
    <rule ref="category/apex/errorprone.xml/ApexCSRF">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/errorprone.xml/AvoidDirectAccessTriggerMap">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/errorprone.xml/AvoidHardcodingId">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/errorprone.xml/EmptyCatchBlock">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/errorprone.xml/EmptyIfStmt">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/errorprone.xml/EmptyStatementBlock">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/errorprone.xml/EmptyTryOrFinallyBlock">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/errorprone.xml/MethodWithSameNameAsEnclosingClass">
        <priority>1</priority>
    </rule>


<!-- PERFORMANCE: https://pmd.github.io/pmd/pmd_rules_apex_performance.html -->
    <rule ref="category/apex/performance.xml/OperationWithLimitsInLoop">
        <priority>1</priority>
    </rule>


    <!-- ================================================================= -->
    <!-- REGLAS DE METADATOS (FLOWS Y VALIDATION RULES)                    -->
    <!-- ================================================================= -->

    <!-- 5. Flows: Descripción Obligatoria -->
    <rule name="FlowDescriptionRequired"
          language="xml"
          message="⚠️ FLOW: El Flow debe tener una descripción completa."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>Es obligatorio documentar qué hace el Flow.</description>
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                    //*[local-name()='Flow']
                       [
                         count(.//*[local-name()='description']) = 0
                         or
                         normalize-space(.//*[local-name()='description']) = ''
                       ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>

    <!-- 6. Validation Rules: Mensaje de Error en Español -->
    <rule name="ValidationRuleErrorMessageSpanish"
          language="xml"
          message="⚠️ VALIDATION: El mensaje de error debe estar en ESPAÑOL."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>Los mensajes de error visibles para el usuario no pueden estar en inglés.</description>
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                    //*[local-name()='errorMessage']
                    [
                        contains(translate(normalize-space(.), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'error') or
                        contains(translate(normalize-space(.), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'value') or
                        contains(translate(normalize-space(.), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'field') or
                        contains(translate(normalize-space(.), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'required') or
                        contains(translate(normalize-space(.), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'invalid') or
                        contains(translate(normalize-space(.), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'please') or
                        contains(translate(normalize-space(.), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'must be')
                    ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>


    <!-- ================================================================= -->
    <!-- REGLAS PARA CAMPOS Y OBJETOS                                      -->
    <!-- ================================================================= -->

    <!-- 1. Descripción Vacía: Valida el nodo description directamente si existe -->
    <rule name="MetadataDescriptionRequired"
          language="xml"
          message="⚠️ ADMIN: El campo/objeto tiene una descripción vacía."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>Si se incluye la etiqueta descripción, no debe estar vacía.</description>
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                    //*[local-name()='description']
                       [normalize-space(text()) = '']
                    ]]>
                </value>
            </property>
        </properties>
    </rule>

    <!-- 2. Naming Convention: PascalCase (Usa text() directamente) -->
    <rule name="ApiNamePascalCase"
          language="xml"
          message="⚠️ NAMING: El API Name debe usar Mayúsculas al inicio y después de cada guion bajo."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                    //*[local-name()='fullName']
                    [
                        contains(normalize-space(text()), '__c')
                        and
                        (
                            contains('abcdefghijklmnopqrstuvwxyz', substring(normalize-space(text()), 1, 1))
                            or
                            contains(translate(substring-before(normalize-space(text()), '__c'), 'abcdefghijklmnopqrstuvwxyz', '00000000000000000000000000'), '_0')
                        )
                    ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>

    <!-- 3. Idioma: Detectar Español en API Names (Usa text() directamente) -->
    <rule name="NoSpanishInApiName"
          language="xml"
          message="⚠️ NAMING: El API Name parece estar en español. Debe ser en INGLÉS."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                    //*[local-name()='fullName']
                    [
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'fecha') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'nombre') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'apellido') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'direccion') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'telefono') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'estado') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'tipo') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'codigo') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'descripcion') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'precio') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'costo') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'cuenta') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'usuario')
                    ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>

    <!-- 4. Idioma: Detectar Inglés en Labels (Usa text() directamente) -->
    <rule name="NoEnglishInLabel"
          language="xml"
          message="⚠️ LABEL: El Label parece estar en inglés. Debe ser en ESPAÑOL."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                    //*[local-name()='label']
                    [
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'date') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'name') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'status') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'type') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'code') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'price') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'cost') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'address') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'phone') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'user') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'account') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'manager') or
                        contains(translate(normalize-space(text()), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'custom')
                    ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>

    <!-- ================================================================= -->
    <!-- REGLAS DE DEBUG (SONDAS)                                          -->
    <!-- =================================================================
    <rule name="DebugChildFullName"
          language="xml"
          message="DEBUG: Encontré un nodo fullName en alguna profundidad (//*)"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <priority>5</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[//*[local-name()='fullName']]]></value>
            </property>
        </properties>
    </rule>

    <rule name="DebugChildLabel"
          language="xml"
          message="DEBUG: Encontré un nodo label en alguna profundidad (//*)"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <priority>5</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[//*[local-name()='label']]]></value>
            </property>
        </properties>
    </rule>

    <rule name="DebugDumpAllNodes"
          language="xml"
          message="DEBUG: Nodo encontrado (verificar línea para saber cuál es)"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>
            Esta regla matchea con CUALQUIER elemento (//*).
            Úsala para ver qué nodos está leyendo realmente el parser.
        </description>
        <priority>5</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[//*]]></value>
            </property>
        </properties>
    </rule>
    -->
</ruleset>