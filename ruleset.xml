<?xml version="1.0" encoding="UTF-8"?>
<ruleset name="Itti Custom Ruleset"
         xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 http://pmd.sourceforge.net/ruleset_2_0_0.xsd">

    <description>
        Reglas customizadas para CRM.
    </description>

    <!-- ================================================================= -->
    <!-- REGLAS PARA APEX                                                  -->
    <!-- ================================================================= -->

<!-- REGLAS CUSTOM -->
    <rule name="EnforceGenerateErrorLogEvent"
          language="apex"
          message="Todo bloque Catch debe llamar a GenerateLogEvent.generateErrorLogEvent(...)"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>
            Asegura que no se silencien errores. Se requiere el uso del logger estandar.
        </description>
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                    //UserClass[not(contains(lower-case(@Image), 'test'))]
                        //CatchBlockStatement[
                            count(
                               .//MethodCallExpression[
                                   lower-case(@MethodName) = 'generateerrorlogevent'
                               ]
                            ) = 0
                        ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>

    <rule name="EnforceDAOPattern"
          language="apex"
          message="No se permiten SOQLs (ni Database.query) en esta clase. Mover la consulta a una clase DAO."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>
            Permite SOQL solo en:
            1. Clases con 'DAO' en el nombre.
            2. Clases que tengan un metodo 'execute' (Batch, Queueable, Schedulable).
            3. Clases que tengan un metodo 'start' (Batch).
        </description>
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                    //UserClass
                    [
                        not(contains(lower-case(@Image), 'dao'))
                    ]
                    [
                        count(.//Method[lower-case(@Image)='execute']) = 0
                    ]
                    [
                        count(.//Method[lower-case(@Image)='start']) = 0
                    ]
                    [
                        count(.//Method[lower-case(@Image)='test']) = 0
                    ]
                    [
                        .//SoqlExpression
                        or
                        .//MethodCallExpression[
                            lower-case(@MethodName) = 'query' and
                            .//ReferenceExpression[lower-case(@Image) = 'database']
                        ]
                    ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>

    <rule name="EnforceSOQLHelperInDAO"
          language="apex"
          message="Los metodos DAO con queries deben utilizar SOQLHelper para garantizar FLS y sanitizacion."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>
            Para asegurar que se respeten los permisos de campos (FLS) y se evite la inyeccion SOQL,
            cualquier consulta en un DAO debe construirse utilizando las utilidades de la clase SOQLHelper.
            Se excluyen las clases de Test.
        </description>
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                //UserClass[contains(lower-case(@Image), 'dao')]
                           [not(contains(lower-case(@Image), 'test'))]
                  //Method
                  [
                    (
                      .//SoqlExpression
                      or
                      .//MethodCallExpression[
                          lower-case(@MethodName) = 'query'
                          and
                          .//ReferenceExpression[lower-case(@Image) = 'database']
                      ]
                    )
                  ]
                  [
                    count(.//ReferenceExpression[lower-case(@Image) = 'soqlhelper']) = 0
                  ]
                ]]>
                </value>
            </property>
        </properties>
    </rule>


<!-- SECURITY: https://pmd.github.io/pmd/pmd_rules_apex_security.html -->
    <rule ref="category/apex/security.xml/ApexOpenRedirect">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/security.xml/ApexSharingViolations">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/security.xml/ApexSuggestUsingNamedCred">
        <priority>1</priority>
    </rule>


<!-- DESIGN: https://pmd.github.io/pmd/pmd_rules_apex_design.html -->
<!-- Por el momento queda solo en warning, pero lo vamos a ajustar a error en el futuro -->
    <rule ref="category/apex/design.xml/ExcessiveParameterList">
        <properties>
            <property name="minimum" value="4" />
        </properties>
    </rule>
    <rule ref="category/apex/design.xml/AvoidDeeplyNestedIfStmts">
        <properties>
            <property name="problemDepth" value="4" />
        </properties>
    </rule>
    <rule ref="category/apex/design.xml/CognitiveComplexity">
        <properties>
            <property name="classReportLevel" value="350" />
            <property name="methodReportLevel" value="35" />
        </properties>
    </rule>


<!-- BEST PRACTICES: https://pmd.github.io/pmd/pmd_rules_apex_bestpractices.html -->
    <rule ref="category/apex/bestpractices.xml/ApexAssertionsShouldIncludeMessage">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/bestpractices.xml/ApexUnitTestClassShouldHaveAsserts">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/bestpractices.xml/ApexUnitTestMethodShouldHaveIsTestAnnotation">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/bestpractices.xml/ApexUnitTestShouldNotUseSeeAllDataTrue">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/bestpractices.xml/AvoidLogicInTrigger">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/bestpractices.xml/UnusedLocalVariable">
        <priority>1</priority>
    </rule>


<!-- CODE STYLE: https://pmd.github.io/pmd/pmd_rules_apex_codestyle.html -->
    <rule ref="category/apex/codestyle.xml/ClassNamingConventions">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/codestyle.xml/MethodNamingConventions">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/codestyle.xml/FieldNamingConventions">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/codestyle.xml/LocalVariableNamingConventions">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/codestyle.xml/PropertyNamingConventions">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/codestyle.xml/ForLoopsMustUseBraces">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/codestyle.xml/FormalParameterNamingConventions">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/codestyle.xml/OneDeclarationPerLine">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/codestyle.xml/WhileLoopsMustUseBraces">
        <priority>1</priority>
    </rule>


<!-- ERROR PRONE: https://pmd.github.io/pmd/pmd_rules_apex_errorprone.html -->
    <rule ref="category/apex/errorprone.xml/ApexCSRF">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/errorprone.xml/AvoidDirectAccessTriggerMap">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/errorprone.xml/AvoidHardcodingId">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/errorprone.xml/EmptyCatchBlock">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/errorprone.xml/EmptyIfStmt">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/errorprone.xml/EmptyStatementBlock">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/errorprone.xml/EmptyTryOrFinallyBlock">
        <priority>1</priority>
    </rule>
    <rule ref="category/apex/errorprone.xml/MethodWithSameNameAsEnclosingClass">
        <priority>1</priority>
    </rule>


<!-- PERFORMANCE: https://pmd.github.io/pmd/pmd_rules_apex_performance.html -->
    <rule ref="category/apex/performance.xml/OperationWithLimitsInLoop">
        <priority>1</priority>
    </rule>



    <!-- ================================================================= -->
    <!-- CUSTOM OBJECTS -->
    <!-- ================================================================= -->
    <rule name="CustomObjectDescriptionRequired"
          language="xml"
          message="Todos los Custom Objects deben tener una descripción detallada."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>
            Verifica que el campo description exista y no esté vacío.
        </description>
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                        //*:CustomObject[
                            count(*:description) = 0
                            or
                            string-length(*:description/text/@Text) = 0
                        ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>


    <!-- ================================================================= -->
    <!-- CUSTOM FIELDS -->
    <!-- ================================================================= -->
    <rule name="CustomFieldNamingConvention"
          language="xml"
          message="El API Name debe separar palabras con guiones bajos (Ej: 'Nombre_Del_Campo')."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>
            Valida dos cosas:
            1. Estructura base: Empieza con Mayúscula y termina en __c/__mdt.
            2. Separación: No permite minúscula seguida de mayúscula sin guion (CamelCase).
        </description>
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                        //*:CustomField/*:fullName/text[
                            not(matches(@Text, '^[A-Z][a-zA-Z0-9]*(_[A-Z][a-zA-Z0-9]*)*(__c|__mdt)$'))
                            or
                            matches(@Text, '.*[a-z][A-Z].*')
                        ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>

    <rule name="CustomFieldDescriptionRequired"
          language="xml"
          message="Todos los campos custom deben tener una descripción detallada."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>
            Verifica que el campo description exista y no esté vacío.
        </description>
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                        //*:CustomField[
                            count(*:description) = 0
                            or
                            string-length(*:description/text/@Text) = 0
                        ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>

    <rule name="CustomFieldApiNameEnglish"
          language="xml"
          message="El API Name debe estar en inglés. Se detectaron caracteres latinos o palabras en español."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>
            Detecta si el fullName contiene:
            1. Caracteres latinos (ñ, tildes).
            2. Palabras comunes en español (Fecha, Nombre, etc).
        </description>
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                        //*:CustomField/*:fullName/text[
                            matches(@Text,
                            '.*([ñáéíóúü]|fecha|nombre|apellido|direccion|telefono|celular|pais|provincia|localidad|barrio|codigo|estado|tipo|precio|costo|monto|cantidad|impuesto|descuento|saldo|vencimiento|pago).*',
                            'i')
                        ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>


    <!-- ================================================================= -->
    <!-- VALIDATION RULES -->
    <!-- ================================================================= -->
    <rule name="ValidationRuleNamingConvention"
          language="xml"
          message="El nombre de la Validation Rule debe comenzar con 'RV_' (Ej: RV_CASE_001_Impide_Cambio_Fecha)."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>
            Estandarización de nombres para fácil identificación en logs y deploy.
        </description>
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                        //*:ValidationRule/*:fullName/text[
                            not(starts-with(@Text, 'RV_'))
                        ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>

    <rule name="ValidationRuleDescriptionRequired"
          language="xml"
          message="La Validation Rule debe tener una descripción explicando su lógica de negocio."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                        //*:ValidationRule[
                            count(*:description) = 0
                            or
                            string-length(*:description/text/@Text) = 0
                        ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>

    <rule name="ValidationRuleBypassRequired"
          language="xml"
          message="La fórmula debe incluir el bypass '$Permission.ByPass_Validation_Rules'."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>
            Busca la cadena '$Permission.ByPass_Validation_Rules' dentro de errorConditionFormula.
            Se selecciona el nodo padre para evitar errores de coordenadas en PMD.
        </description>
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                        //*:ValidationRule/*:errorConditionFormula[
                            not(contains(text/@Text, '$Permission.ByPass_Validation_Rules'))
                        ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>

    <rule name="ValidationRuleMessageIdentifier"
          language="xml"
          message="El mensaje de error debe contener el código de la regla (el FullName o al menos 'RV_')."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>
            Verifica que errorMessage contenga 'RV_' O el fullName de la regla.
        </description>
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                        //*:ValidationRule[
                            not(contains(*:errorMessage/text/@Text, 'RV_'))
                            and
                            not(contains(*:errorMessage/text/@Text, *:fullName/text/@Text))
                        ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>

    <!-- ================================================================= -->
    <!-- FLOWS -->
    <!-- ================================================================= -->
    <rule name="FlowDescriptionWithTag"
          language="xml"
          message="Todo Flow debe tener una descripción, y debe incluir un tag de equipo: [Eco], [Sales], [Core] o [Service]."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>
            Valida clasificación del flow mediante tags en la descripción.
        </description>
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                        //*:Flow[
                            count(*:description) = 0
                            or
                            not(matches(*:description/text/@Text, '.*\[(eco|sales|core|service)\].*', 'i'))
                        ]
                    ]]>
                </value>
            </property>
        </properties>
    </rule>

    <rule name="FlowEntryConditionBypass"
          language="xml"
          message="Los Record-Triggered Flows deben usar una Fórmula de Entrada e incluir '$Permission.ByPass_Flow'."
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <description>
            Verifica Record-Triggered Flows.
            Usa '.' para leer fórmulas multilínea correctamente.
        </description>
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
                    <![CDATA[
                        //*:Flow
                        [
                            count(*:start/*:filterFormula) = 0
                            or
                            not(contains(*:start/*:filterFormula, '$Permission.ByPass_Flow'))
                        ]
                ]]>
                </value>
            </property>
        </properties>
    </rule>

</ruleset>