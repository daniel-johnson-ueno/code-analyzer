name: Salesforce Code Analyzer

on:
  workflow_dispatch:
  pull_request:
    branches: [main, uat]
  push:
    branches: [main, uat]

jobs:
  code-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: "17"

      - name: Install PMD 7
        run: |
          # Descargamos PMD 7.0.0 (Puedes cambiar el n√∫mero si sale una m√°s nueva) -
          wget https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.0.0/pmd-dist-7.0.0-bin.zip -q
          unzip -q pmd-dist-7.0.0-bin.zip
          # Agregamos al PATH. Nota: La carpeta extra√≠da se llama pmd-bin-7.0.0
          echo "$(pwd)/pmd-bin-7.0.0/bin" >> $GITHUB_PATH

      - name: Get changed files
        id: changes
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi
          
          if [[ -z "${BASE_SHA}" || "${BASE_SHA}" =~ ^0+$ ]]; then
            BASE_SHA="$(git rev-parse "${HEAD_SHA}^" 2>/dev/null || echo "")"
          fi
          
          CHANGED=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -E '\.(cls|trigger|page|component)$' | grep -v 'meta.xml' | grep -v 'ruleset.xml' | grep -v 'package.xml' | tr '\n' ',' | sed 's/,$//')
          
          if [[ -z "$CHANGED" ]]; then
            echo "has_files=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_files=true" >> "$GITHUB_OUTPUT"
            echo "files=$CHANGED" >> "$GITHUB_OUTPUT"
          fi

      - name: Run PMD Analysis
        if: steps.changes.outputs.has_files == 'true'
        run: |
          echo "Analizando archivos..."
          pmd check -d "${{ steps.changes.outputs.files }}" -R ruleset.xml -f csv -r results.csv --force-language apex || true

      - name: Process Results & Publish Summary
        if: steps.changes.outputs.has_files == 'true'
        run: |
          if [ ! -s results.csv ] || [ $(wc -l < results.csv) -le 1 ]; then
             echo "‚úÖ **C√≥digo Limpio**" >> $GITHUB_STEP_SUMMARY
             exit 0
          fi

          echo "### üîç Reporte PMD 7" >> $GITHUB_STEP_SUMMARY
          echo "| Severidad | Regla | Archivo:Linea | Mensaje |" >> $GITHUB_STEP_SUMMARY
          echo "| :---: | :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY

          awk -F '","' '
          NR > 1 {
            gsub(/^"|"$/, "", $0)
            fileFull = $3; prio = $4; line = $5; desc = $6; rule = $8
            n = split(fileFull, pathParts, "/"); fileName = pathParts[n]
            icon = "üü°"; if (prio == "1" || prio == "2") icon = "üî¥"
            printf "| %s %s | **%s** | `%s:%s` | %s |\n", icon, prio, rule, fileName, line, desc
          }
          ' results.csv >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          
          CRITICAL_ERRORS=$(grep -E '","[12]","' results.csv | wc -l)
          if [ "$CRITICAL_ERRORS" -gt 0 ]; then
            echo "::error::‚õî $CRITICAL_ERRORS ERRORES CR√çTICOS."
            exit 1
          fi