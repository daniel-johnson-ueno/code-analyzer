name: Salesforce Code Analyzer

on:
  workflow_dispatch:
  pull_request:
    branches: [main, uat]
  push:
    branches: [main, uat]

jobs:
  code-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: "11"

      - name: Install PMD
        run: |
          wget https://github.com/pmd/pmd/releases/download/pmd_releases%2F6.55.0/pmd-bin-6.55.0.zip -q
          unzip -q pmd-bin-6.55.0.zip
          echo "$(pwd)/pmd-bin-6.55.0/bin" >> $GITHUB_PATH

      - name: Get changed files
        id: changes
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi
          
          if [[ -z "${BASE_SHA}" || "${BASE_SHA}" =~ ^0+$ ]]; then
            BASE_SHA="$(git rev-parse "${HEAD_SHA}^" 2>/dev/null || echo "")"
          fi
          
          # Excluimos archivos que no sean c√≥digo fuente relevante
          CHANGED=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -E '\.(cls|trigger|page|component)$' | grep -v 'meta.xml' | grep -v 'ruleset.xml' | grep -v 'package.xml' | tr '\n' ',' | sed 's/,$//')
          
          if [[ -z "$CHANGED" ]]; then
            echo "has_files=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_files=true" >> "$GITHUB_OUTPUT"
            echo "files=$CHANGED" >> "$GITHUB_OUTPUT"
          fi

      # PASO 1: Ejecutar PMD y generar CSV
      # Usamos '|| true' para que el paso no falle aqu√≠,
      # queremos procesar el resultado nosotros mismos en el siguiente paso.
      - name: Run PMD Analysis
        if: steps.changes.outputs.has_files == 'true'
        run: |
          echo "Analizando archivos..."
          run.sh pmd -d "${{ steps.changes.outputs.files }}" -R ruleset.xml -f csv -r results.csv || true

      # PASO 2: Generar Tabla en Summary y Bloquear si es necesario
      # Este script lee el CSV y crea una tabla Markdown visible en GitHub.
      - name: Process Results & Publish Summary
        if: steps.changes.outputs.has_files == 'true'
        run: |
          # Si el archivo CSV no existe o est√° vac√≠o (salvo header), salimos √©xito.
          if [ ! -s results.csv ] || [ $(wc -l < results.csv) -le 1 ]; then
             echo "‚úÖ **Felicidades, c√≥digo limpio!** No se encontraron violaciones." >> $GITHUB_STEP_SUMMARY
             exit 0
          fi

          echo "### üîç Reporte Detallado PMD" >> $GITHUB_STEP_SUMMARY
          echo "A continuaci√≥n se listan todas las violaciones encontradas en los archivos modificados:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Generamos la cabecera de la tabla Markdown
          echo "| Severidad | Regla | Archivo:Linea | Mensaje |" >> $GITHUB_STEP_SUMMARY
          echo "| :---: | :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY

          # Usamos AWK para parsear el CSV de PMD y convertirlo a filas de tabla Markdown
          # Formato CSV PMD: "Problem","Package","File","Priority","Line","Desc","RuleSet","Rule"
          awk -F '","' '
          NR > 1 {
            # Limpiamos comillas extra al principio y final de la linea si existen
            gsub(/^"|"$/, "", $0)
          
            # Asignamos variables basadas en columnas (ajusta seg√∫n versi√≥n PMD si var√≠a)
            fileFull = $3
            prio = $4
            line = $5
            desc = $6
            rule = $8
          
            # Limpiamos el path del archivo para que no sea tan largo (solo nombre)
            n = split(fileFull, pathParts, "/")
            fileName = pathParts[n]

            # Definimos Icono seg√∫n prioridad
            icon = "üü°"
            if (prio == "1" || prio == "2") icon = "üî¥"

            # Imprimimos la fila en formato Markdown
            printf "| %s %s | **%s** | `%s:%s` | %s |\n", icon, prio, rule, fileName, line, desc
          }
          ' results.csv >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ÑπÔ∏è _üî¥=Bloqueante (Prio 1-2) | üü°=Advertencia (Prio 3-5)_" >> $GITHUB_STEP_SUMMARY

          # --- L√ìGICA DE BLOQUEO ---
          # Buscamos si existe alguna linea con prioridad "1" o "2" en el CSV original
          CRITICAL_COUNT=$(grep -E '","[12]","' results.csv | wc -l)
          
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "::error::‚õî SE ENCONTRARON $CRITICAL_COUNT ERRORES CR√çTICOS. Revisa el Summary para ver los detalles."
            exit 1
          else
            echo "‚úÖ Se encontraron advertencias, pero ning√∫n error bloqueante."
            exit 0
          fi