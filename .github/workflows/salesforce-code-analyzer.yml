name: Salesforce Code Analyzer

on:
  workflow_dispatch:
  pull_request:
    branches: [main, uat]
  push:
    branches: [main, uat]

jobs:
  code-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Java es lo único que necesita PMD puro
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: "11"

      # Descargamos PMD 6.55.0 (Compatible con tu ruleset actual)
      - name: Install PMD
        run: |
          wget https://github.com/pmd/pmd/releases/download/pmd_releases%2F6.55.0/pmd-bin-6.55.0.zip
          unzip pmd-bin-6.55.0.zip
          echo "$(pwd)/pmd-bin-6.55.0/bin" >> $GITHUB_PATH

      - name: Get changed files
        id: changes
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi
          
          if [[ -z "${BASE_SHA}" || "${BASE_SHA}" =~ ^0+$ ]]; then
            BASE_SHA="$(git rev-parse "${HEAD_SHA}^" 2>/dev/null || echo "")"
          fi
          
          # Generamos una lista limpia separada por comas
          CHANGED=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -E '\.(cls|trigger)$' | grep -v 'meta.xml' | tr '\n' ',' | sed 's/,$//')
          
          if [[ -z "$CHANGED" ]]; then
            echo "has_files=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_files=true" >> "$GITHUB_OUTPUT"
            echo "files=$CHANGED" >> "$GITHUB_OUTPUT"
          fi

      # Ejecutamos PMD directamente usando tu ruleset.xml
      - name: Run PMD Analysis
        if: steps.changes.outputs.has_files == 'true'
        run: |
          echo "Analizando archivos: ${{ steps.changes.outputs.files }}"
          
          # run.sh pmd -d "archivos" -R reglas.xml -f formato
          # Nota: PMD requiere comas para listas de archivos en -d
          run.sh pmd -d "${{ steps.changes.outputs.files }}" -R ruleset.xml -f html -r results.html

      - name: Upload Results
        if: always() && steps.changes.outputs.has_files == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pmd-results
          path: results.html

      # Verificación simple de fallos (buscando si el reporte tiene violaciones)
      # Esta es una forma rústica pero efectiva de fallar el build si hay errores.
      - name: Check Quality Gate
        if: steps.changes.outputs.has_files == 'true'
        run: |
          # Corremos de nuevo en formato texto para ver en consola y chequear status
          run.sh pmd -d "${{ steps.changes.outputs.files }}" -R ruleset.xml -f text -r console_output.txt
          cat console_output.txt
          
          # Si el archivo tiene contenido (errores), fallamos.
          if [ -s console_output.txt ]; then
            echo "::error::PMD encontró violaciones de reglas."
            exit 1
          fi