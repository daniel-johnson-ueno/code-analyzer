name: Salesforce Code Analyzer

on:
  workflow_dispatch:
  pull_request:
    branches: [main, uat]
  push:
    branches: [main, uat]

jobs:
  code-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Paso para detectar si es un Sync de Gearset
      - name: Check if Gearset Sync
        id: check_sync
        run: |
          HEAD_REF="${{ github.head_ref }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          HEAD_LOWER=$(echo "$HEAD_REF" | tr '[:upper:]' '[:lower:]')
          TITLE_LOWER=$(echo "$PR_TITLE" | tr '[:upper:]' '[:lower:]')
          
          # Si la rama o el titulo dicen "Sync UATGV with main", se marca para no correr el analisis.
          if [[ "$HEAD_LOWER" == *"Sync UATGV with main"* ]] || [[ "$TITLE_LOWER" == *"Sync UATGV with main"* ]]; then
            echo "::notice::üîÑ Detectado PR de Sincronizaci√≥n de Gearset. Se omitir√° el an√°lisis de c√≥digo."
            echo "is_sync=true" >> $GITHUB_OUTPUT
          else
            echo "is_sync=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Java
        if: steps.check_sync.outputs.is_sync != 'true'
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: "17"

      - name: Install PMD 7
        if: steps.check_sync.outputs.is_sync != 'true'
        run: |
          wget https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.0.0/pmd-dist-7.0.0-bin.zip -q
          unzip -q pmd-dist-7.0.0-bin.zip
          echo "$(pwd)/pmd-bin-7.0.0/bin" >> $GITHUB_PATH

      # Logica Inteligente de Diff
      - name: Get changed files
        id: changes
        if: steps.check_sync.outputs.is_sync != 'true'
        run: |
          RAW_DIFF_FILE="raw_diff.txt"
          FILES_TO_SCAN="files_to_scan.txt"
          
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            # ESTRATEGIA: Como la feature nace de MAIN, comparamos contra MAIN.
            # Esto ignora el delta gigante que pueda haber con UATGV.
            
            echo "Obteniendo referencia de main..."
            git fetch origin main
            
            PR_HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            
            echo "Calculando diff relativo a origin/main..."
            git diff --name-only origin/main...$PR_HEAD_SHA > $RAW_DIFF_FILE
          
          else
            # L√≥gica est√°ndar para PUSH (no PR)
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
            if [[ -z "${BASE_SHA}" || "${BASE_SHA}" =~ ^0+$ ]]; then
               BASE_SHA="$(git rev-parse "${HEAD_SHA}^" 2>/dev/null || echo "")"
            fi
            git diff --name-only "$BASE_SHA" "$HEAD_SHA" > $RAW_DIFF_FILE
          fi
          
          touch $FILES_TO_SCAN
          count=0
          
          while IFS= read -r file; do
            # Aceptamos Apex, Triggers, Pages, Campos y Objetos
            if [[ "$file" =~ \.(cls|trigger|page|component)$ ]] && [[ ! "$file" =~ -meta.xml ]]; then
               if [ -f "$file" ]; then echo "$file" >> $FILES_TO_SCAN; count=$((count+1)); fi
          
            # Detectar Campos (.field-meta.xml) y Objetos (.object-meta.xml)
            elif [[ "$file" =~ \.field-meta\.xml$ ]] || [[ "$file" =~ \.object-meta\.xml$ ]]; then
               if [ -f "$file" ]; then echo "$file" >> $FILES_TO_SCAN; count=$((count+1)); fi
            fi
          done < $RAW_DIFF_FILE
          
          if [ "$count" -gt 0 ]; then
            echo "‚úÖ Se encontraron $count archivos modificados para analizar."
            echo "has_files=true" >> "$GITHUB_OUTPUT"
            cat $FILES_TO_SCAN
          else
            echo "‚ö†Ô∏è No hay archivos de c√≥digo modificados."
            echo "has_files=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run PMD Analysis
        if: steps.check_sync.outputs.is_sync != 'true' && steps.changes.outputs.has_files == 'true'
        run: |
          echo "üöÄ Ejecutando PMD sobre archivos modificados..."
          pmd check --file-list files_to_scan.txt -R ruleset.xml -f csv -r results.csv || true

      - name: Process Results & Publish Summary
        if: steps.check_sync.outputs.is_sync != 'true' && steps.changes.outputs.has_files == 'true'
        run: |
          if [ ! -s results.csv ] || [ $(wc -l < results.csv) -le 1 ]; then
             echo "‚úÖ **C√≥digo Limpio**" >> $GITHUB_STEP_SUMMARY
             exit 0
          fi

          echo "### üîç Reporte PMD 7" >> $GITHUB_STEP_SUMMARY
          echo "| Severidad | Regla | Archivo:Linea | Mensaje |" >> $GITHUB_STEP_SUMMARY
          echo "| :---: | :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY

          awk -F '","' '
          NR > 1 {
            gsub(/^"|"$/, "", $0)
            fileFull = $3; prio = $4; line = $5; desc = $6; rule = $8
            n = split(fileFull, pathParts, "/"); fileName = pathParts[n]
            icon = "üü°"; if (prio == "1" || prio == "2") icon = "üî¥"
            printf "| %s %s | **%s** | `%s:%s` | %s |\n", icon, prio, rule, fileName, line, desc
          }
          ' results.csv >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # MODO TEST: Solo avisa, no bloquea (exit 0)
          CRITICAL_ERRORS=$(grep -E '","[12]","' results.csv | wc -l)
          if [ "$CRITICAL_ERRORS" -gt 0 ]; then
            echo "::warning::‚õî SE DETECTARON $CRITICAL_ERRORS ERRORES CR√çTICOS (Modo Test: No bloqueante)."
            exit 0
          fi
