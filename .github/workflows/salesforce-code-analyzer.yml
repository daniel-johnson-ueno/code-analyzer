name: Salesforce Code Analyzer

on:
  workflow_dispatch:
  pull_request:
    branches: [main, uat]
  push:
    branches: [main, uat]

jobs:
  code-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      security-events: write # Necesario para subir el reporte SARIF
      actions: read

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: "11"

      # Instalamos PMD 6.55.0 (Compatible y estable)
      - name: Install PMD
        run: |
          wget https://github.com/pmd/pmd/releases/download/pmd_releases%2F6.55.0/pmd-bin-6.55.0.zip -q
          unzip -q pmd-bin-6.55.0.zip
          echo "$(pwd)/pmd-bin-6.55.0/bin" >> $GITHUB_PATH

      - name: Get changed files
        id: changes
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi
          
          if [[ -z "${BASE_SHA}" || "${BASE_SHA}" =~ ^0+$ ]]; then
            BASE_SHA="$(git rev-parse "${HEAD_SHA}^" 2>/dev/null || echo "")"
          fi
          
          # Excluimos meta.xml, ruleset.xml y package.xml
          CHANGED=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -E '\.(cls|trigger|page|component)$' | grep -v 'meta.xml' | grep -v 'ruleset.xml' | grep -v 'package.xml' | tr '\n' ',' | sed 's/,$//')
          
          if [[ -z "$CHANGED" ]]; then
            echo "has_files=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_files=true" >> "$GITHUB_OUTPUT"
            echo "files=$CHANGED" >> "$GITHUB_OUTPUT"
          fi

      # 1. Ejecuci√≥n para VISUALIZACI√ìN (Formato SARIF)
      # Esto permite que GitHub pinte los errores en el c√≥digo y en la pesta√±a Security.
      - name: Run PMD (SARIF Report)
        if: steps.changes.outputs.has_files == 'true'
        run: |
          run.sh pmd -d "${{ steps.changes.outputs.files }}" -R ruleset.xml -f sarif -r results.sarif || true
          # El '|| true' es importante para que el script no se detenga aqu√≠, 
          # queremos procesar los resultados nosotros mismos m√°s abajo.

      # 2. Subir reporte SARIF a GitHub
      # Esto hace que aparezcan las anotaciones en el PR.
      - name: Upload SARIF to GitHub
        if: steps.changes.outputs.has_files == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: pmd-apex

      # 3. Ejecuci√≥n para CONTROL DE CALIDAD (Formato CSV)
      # Usamos CSV para poder parsear f√°cilmente la prioridad y decidir si bloqueamos.
      - name: Check Priorities & Block PR
        if: steps.changes.outputs.has_files == 'true'
        run: |
          echo "### üõ°Ô∏è Resultados del An√°lisis PMD" >> $GITHUB_STEP_SUMMARY
          
          # Generamos reporte CSV temporal
          run.sh pmd -d "${{ steps.changes.outputs.files }}" -R ruleset.xml -f csv -r results.csv || true
          
          # Contamos errores Totales (restando 1 por el header)
          TOTAL_ERRORS=$(($(wc -l < results.csv) - 1))
          # Si el archivo est√° vac√≠o o solo tiene header, es 0
          if [ "$TOTAL_ERRORS" -lt 0 ]; then TOTAL_ERRORS=0; fi
          
          # Buscamos Errores Cr√≠ticos (Prioridad 1 y 2)
          # El formato CSV de PMD pone la prioridad entre comillas, ej: "1" o "2"
          # La columna de prioridad suele ser la 4ta, pero grep es m√°s seguro buscando el patr√≥n.
          CRITICAL_COUNT=$(grep -E '","[12]","' results.csv | wc -l)
          WARNING_COUNT=$(($TOTAL_ERRORS - $CRITICAL_COUNT))
          
          echo "| Tipo | Cantidad |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :---: |" >> $GITHUB_STEP_SUMMARY
          echo "| üî¥ **Bloqueantes (Prio 1-2)** | $CRITICAL_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| üü° Advertencias (Prio 3-5) | $WARNING_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Mostramos detalles de los errores cr√≠ticos en el log
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "::error::‚õî SE ENCONTRARON $CRITICAL_COUNT ERRORES CR√çTICOS (Prioridad 1 o 2). El PR no puede fusionarse."
            echo "Detalle de errores cr√≠ticos:"
            grep -E '","[12]","' results.csv
          
            # BLOQUEO DEL PR
            exit 1
          else
            echo "‚úÖ No se encontraron errores bloqueantes. El pipeline pasa."
            if [ "$WARNING_COUNT" -gt 0 ]; then
               echo "::warning::Se encontraron $WARNING_COUNT advertencias de baja prioridad."
            fi
            exit 0
          fi