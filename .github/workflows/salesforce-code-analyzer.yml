name: Salesforce Code Analyzer

on:
  workflow_dispatch:
  pull_request:
    branches: [main, uat]
  push:
    branches: [main, uat]

jobs:
  code-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: "11"

      - name: Install PMD
        run: |
          wget https://github.com/pmd/pmd/releases/download/pmd_releases%2F6.55.0/pmd-bin-6.55.0.zip -q
          unzip -q pmd-bin-6.55.0.zip
          echo "$(pwd)/pmd-bin-6.55.0/bin" >> $GITHUB_PATH

      - name: Get changed files
        id: changes
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi
          
          if [[ -z "${BASE_SHA}" || "${BASE_SHA}" =~ ^0+$ ]]; then
            BASE_SHA="$(git rev-parse "${HEAD_SHA}^" 2>/dev/null || echo "")"
          fi
          
          # BUSCAMOS LOS ARCHIVOS QUE TIENEN CAMBIOS. POR EL MOMENTO SOLO ESCANEAMOS .CLS Y .TRIGGER
          CHANGED=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -E '\.(cls|trigger)$' | grep -v 'meta.xml' | grep -v 'ruleset.xml' | grep -v 'package.xml' | tr '\n' ',' | sed 's/,$//')
          
          if [[ -z "$CHANGED" ]]; then
            echo "has_files=false" >> "$GITHUB_OUTPUT"
            echo "No se encontraron archivos de c√≥digo modificados."
          else
            echo "has_files=true" >> "$GITHUB_OUTPUT"
            echo "files=$CHANGED" >> "$GITHUB_OUTPUT"
          fi

      - name: Run PMD Analysis
        if: steps.changes.outputs.has_files == 'true'
        run: |
          echo "Analizando archivos: ${{ steps.changes.outputs.files }}"
          # '|| true' evita que el script pare si encuentra errores, para poder procesarlos al final y evitar los warnings.
          run.sh pmd -d "${{ steps.changes.outputs.files }}" -R ruleset.xml -f csv -r results.csv || true

      - name: Process Results & Publish Summary
        if: steps.changes.outputs.has_files == 'true'
        run: |
          if [ ! -s results.csv ] || [ $(wc -l < results.csv) -le 1 ]; then
             echo "‚úÖ **C√≥digo Limpio** - No se encontraron violaciones en los archivos modificados." >> $GITHUB_STEP_SUMMARY
             exit 0
          fi

          echo "### üîç Reporte Detallado PMD" >> $GITHUB_STEP_SUMMARY
          echo "| Severidad | Regla | Archivo:Linea | Mensaje |" >> $GITHUB_STEP_SUMMARY
          echo "| :---: | :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY

          awk -F '","' '
          NR > 1 {
            # $3 = File path, $4 = Priority, $5 = Line, $6 = Description, $8 = Rule
          
            prio = $4
            gsub(/"/, "", prio)
          
            fileFull = $3
            gsub(/"/, "", fileFull)
          
            line = $5
            gsub(/"/, "", line)
          
            desc = $6
            gsub(/"/, "", desc)
          
            rule = $8
            gsub(/"/, "", rule)

            # Extraer solo nombre de archivo
            n = split(fileFull, pathParts, "/")
            fileName = pathParts[n]

            icon = "üü°"
            if (prio == "1" || prio == "2") icon = "üî¥"

            printf "| %s | **%s** | `%s:%s` | %s |\n", icon, rule, fileName, line, desc
          }
          ' results.csv >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ÑπÔ∏è _üî¥ Bloqueante | üü° Advertencia_" >> $GITHUB_STEP_SUMMARY

          # BLOQUEO: Buscamos Prioridad 1 o 2 en el CSV.
          CRITICAL_ERRORS=$(grep -E '","[12]","' results.csv | wc -l)

          if [ "$CRITICAL_ERRORS" -gt 0 ]; then
            echo "::error::‚õî SE ENCONTRARON $CRITICAL_ERRORS ERRORES CR√çTICOS. El Pull Request ha sido bloqueado."
            exit 1
          else
            echo "‚úÖ An√°lisis completado. Solo se encontraron advertencias."
            exit 0
          fi